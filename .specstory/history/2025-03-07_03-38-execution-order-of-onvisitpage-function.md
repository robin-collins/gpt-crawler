<!-- Generated by SpecStory -->

# Execution Order of onVisitPage Function (2025-03-07 14:08:06)

_**User**_

can you please confirm that the `onVisitPage` functions from the config file are executed BEFORE the page is converted to markdown by the turndown service + jsdom

---

_**Assistant**_

Looking at the code in `src/core.ts`, I can see that the `onVisitPage` function is actually executed **after** the content has already been captured for markdown conversion, not before.

Here's the relevant sequence in the `requestHandler` function:

```typescript:src/core.ts
// First, the HTML content is captured and processed
const html = await page.content();
const dom = new JSDOM(html, { url: request.loadedUrl });
const reader = new Readability(dom.window.document);
const article = reader.parse();

// Then data is pushed with the captured content
await pushDataWrapper({
  title: article?.title || title,
  url: request.loadedUrl,
  content: article?.content || "",
  textContent: article?.textContent || "",
  excerpt: article?.excerpt || "",
  byline: article?.byline || "",
  siteName: article?.siteName || "",
});

// Only AFTER content capture is the onVisitPage function called
if (config.onVisitPage) {
  await config.onVisitPage({ page, pushData: pushDataWrapper });
}
```

This means that any DOM modifications made by the `onVisitPage` function (such as removing unwanted elements) will not affect the content that's already been captured and pushed for markdown conversion.

According to the cursor rules context, this is a known issue:

> The order of operations in `core.ts` must ensure that `removeNodesFromDOM` is executed _before_ content is captured for markdown output. Currently, content capture precedes the execution of the removal function, resulting in unwanted content in the output.

To fix this issue, the `onVisitPage` function should be called before the content is captured and processed by Readability, so that any DOM modifications can take effect before the content is saved.

---

_**User**_

please fix the issue so that the onVisitPage is called before the content is captured and processed by Readability.

---

_**Assistant**_

I'll fix the issue by moving the `onVisitPage` function call to execute before the content is captured and processed by Readability. Here's the necessary change:

```typescript:src/core.ts
// ... existing code ...
          const title = await page.title();
          pageCounter++;
          log.info(
            `Crawling: Page ${pageCounter} / ${config.maxPagesToCrawl} - URL: ${request.loadedUrl}...`,
          );

          // Use custom handling for XPath selector
          if (config.selector) {
            if (config.selector.startsWith("/")) {
              await waitForXPath(
                page,
                config.selector,
                config.waitForSelectorTimeout ?? 1000,
              );
            } else {
              await page.waitForSelector(config.selector, {
                timeout: config.waitForSelectorTimeout ?? 1000,
              });
            }
          }

          // Create a wrapper for pushData that matches the expected type
          const pushDataWrapper = async (data: any) => {
            await pushData(data);
          };

          // Execute onVisitPage BEFORE content capture
          if (config.onVisitPage) {
            await config.onVisitPage({ page, pushData: pushDataWrapper });
          }

          // Now capture the content AFTER any DOM modifications
          const html = await page.content();
          const dom = new JSDOM(html, { url: request.loadedUrl });
          const reader = new Readability(dom.window.document);
          const article = reader.parse();

          // Save results
          await pushDataWrapper({
            title: article?.title || title,
            url: request.loadedUrl,
            content: article?.content || "",
            textContent: article?.textContent || "",
            excerpt: article?.excerpt || "",
            byline: article?.byline || "",
            siteName: article?.siteName || "",
          });

          // Remove the duplicate onVisitPage call that was here previously

          // Extract links from the current page
          // ... existing code ...
```

This change moves the `onVisitPage` function call to execute before the content is captured and processed by Readability. Now any DOM modifications made by the `onVisitPage` function (such as removing unwanted elements) will affect the content that's captured for markdown conversion.

The key changes are:

1. Added the `onVisitPage` call before content capture
2. Removed the duplicate `onVisitPage` call that was previously after content capture
3. Kept the same `pushDataWrapper` function to maintain consistency

This fix ensures that any DOM modifications (like removing unwanted nodes) will be reflected in the final markdown output.

---

---
